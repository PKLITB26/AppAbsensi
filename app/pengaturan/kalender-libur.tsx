import React, { useState, useEffect } from 'react';
import { View, Text, StyleSheet, ScrollView, TouchableOpacity, Modal, TextInput, Alert, FlatList } from 'react-native';
import { StatusBar } from 'expo-status-bar';
import { Ionicons } from '@expo/vector-icons';
import { useRouter } from 'expo-router';
import { useFocusEffect } from '@react-navigation/native';
import { PengaturanAPI } from '../../constants/config';
import { AppHeader, SkeletonLoader } from '../../components';

interface HariLibur {
  id: number;
  tanggal: string;
  nama_libur: string;
  jenis: string;
}

interface JamKerjaHari {
  hari: string;
  is_kerja: boolean;
}

export default function KalenderLiburScreen() {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [hariLibur, setHariLibur] = useState<HariLibur[]>([]);
  const [jamKerja, setJamKerja] = useState<JamKerjaHari[]>([]);
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);
  const [formData, setFormData] = useState({
    namaLibur: '',
    jenis: 'nasional'
  });

  useFocusEffect(
    React.useCallback(() => {
      fetchHariLibur();
      fetchJamKerja();
    }, [])
  );

  const fetchHariLibur = async () => {
    try {
      setLoading(true);
      const response = await PengaturanAPI.getHariLibur();
      if (response.success && response.data) {
        setHariLibur(response.data);
      }
    } catch (error) {
      console.error('Error fetching hari libur:', error);
    } finally {
      setLoading(false);
    }
  };

  const fetchJamKerja = async () => {
    try {
      const response = await PengaturanAPI.getJamKerja();
      if (response.success && response.data) {
        setJamKerja(response.data);
      }
    } catch (error) {
      console.error('Error fetching jam kerja:', error);
    }
  };

  const getDaysInMonth = () => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    const days = [];
    for (let i = 0; i < startingDayOfWeek; i++) {
      days.push(null);
    }
    for (let i = 1; i <= daysInMonth; i++) {
      days.push(new Date(year, month, i));
    }
    return days;
  };

  const isWeekend = (date: Date | null) => {
    if (!date || jamKerja.length === 0) return false;
    const dayIndex = date.getDay();
    const hariMap = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    const namaHari = hariMap[dayIndex];
    const jamKerjaHari = jamKerja.find(jk => jk.hari === namaHari);
    return jamKerjaHari ? !jamKerjaHari.is_kerja : false;
  };

  const isHoliday = (date: Date | null) => {
    if (!date) return false;
    // Format tanggal lokal tanpa konversi timezone
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`;
    
    return hariLibur.some(h => {
      // Konversi tanggal dari server (ISO format) ke format YYYY-MM-DD
      const serverDate = new Date(h.tanggal);
      const serverDateStr = `${serverDate.getFullYear()}-${String(serverDate.getMonth() + 1).padStart(2, '0')}-${String(serverDate.getDate()).padStart(2, '0')}`;
      return serverDateStr === dateStr;
    });
  };

  const getHolidayInfo = (date: Date | null) => {
    if (!date) return null;
    // Format tanggal lokal tanpa konversi timezone
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const dateStr = `${year}-${month}-${day}`;
    
    return hariLibur.find(h => {
      // Konversi tanggal dari server (ISO format) ke format YYYY-MM-DD
      const serverDate = new Date(h.tanggal);
      const serverDateStr = `${serverDate.getFullYear()}-${String(serverDate.getMonth() + 1).padStart(2, '0')}-${String(serverDate.getDate()).padStart(2, '0')}`;
      return serverDateStr === dateStr;
    });
  };

  const handleDatePress = (date: Date | null) => {
    if (!date) return;
    const holiday = getHolidayInfo(date);
    if (holiday) {
      Alert.alert(
        holiday.nama_libur,
        `Jenis: ${holiday.jenis}\nTanggal: ${new Date(holiday.tanggal).toLocaleDateString('id-ID')}`,
        [
          { text: 'Hapus', style: 'destructive', onPress: () => handleDeleteHoliday(holiday.id) },
          { text: 'Tutup', style: 'cancel' }
        ]
      );
    } else {
      setSelectedDate(date);
      setFormData({ namaLibur: '', jenis: 'nasional' });
      setShowModal(true);
    }
  };

  const handleSaveHoliday = async () => {
    if (!selectedDate || !formData.namaLibur.trim()) {
      Alert.alert('Error', 'Nama libur wajib diisi');
      return;
    }

    try {
      setLoading(true);
      
      // Format tanggal dengan benar (YYYY-MM-DD) tanpa konversi timezone
      const year = selectedDate.getFullYear();
      const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
      const day = String(selectedDate.getDate()).padStart(2, '0');
      const formattedDate = `${year}-${month}-${day}`;
      
      console.log('Tanggal yang dipilih:', formattedDate);
      
      const response = await PengaturanAPI.saveHariLibur({
        tanggal: formattedDate,
        nama_libur: formData.namaLibur.trim(),
        jenis: formData.jenis
      });

      if (response.success) {
        // Update state lokal langsung untuk refresh UI
        const newHoliday: HariLibur = {
          id: response.data?.id || Date.now(), // fallback ID jika tidak ada dari response
          tanggal: formattedDate,
          nama_libur: formData.namaLibur.trim(),
          jenis: formData.jenis
        };
        
        setHariLibur(prev => [...prev, newHoliday]);
        setShowModal(false);
        
        Alert.alert('Sukses', 'Hari libur berhasil ditambahkan');
        
        // Fetch ulang untuk memastikan sinkronisasi dengan server
        await fetchHariLibur();
      } else {
        Alert.alert('Error', response.message || 'Gagal menyimpan hari libur');
      }
    } catch (error) {
      Alert.alert('Error', 'Terjadi kesalahan saat menyimpan');
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteHoliday = async (id: number) => {
    try {
      const response = await PengaturanAPI.deleteHariLibur(id);
      if (response.success) {
        // Update state lokal langsung untuk refresh UI
        setHariLibur(prev => prev.filter(h => h.id !== id));
        
        Alert.alert('Sukses', 'Hari libur berhasil dihapus');
        
        // Fetch ulang untuk memastikan sinkronisasi dengan server
        await fetchHariLibur();
      } else {
        Alert.alert('Error', response.message || 'Gagal menghapus hari libur');
      }
    } catch (error) {
      Alert.alert('Error', 'Terjadi kesalahan saat menghapus');
    }
  };

  const changeMonth = (direction: number) => {
    const newMonth = new Date(currentMonth);
    newMonth.setMonth(currentMonth.getMonth() + direction);
    setCurrentMonth(newMonth);
  };

  const days = getDaysInMonth();
  const monthName = currentMonth.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });

  return (
    <View style={styles.container}>
      <StatusBar style="dark" translucent={true} backgroundColor="transparent" />
      
      <AppHeader 
        title="Kalender Libur"
        showBack={true}
      />

      <ScrollView style={styles.content}>
        {loading ? (
          <SkeletonLoader type="card" count={3} message="Memuat kalender libur..." />
        ) : (
          <>
            <View style={styles.infoCard}>
              <Ionicons name="information-circle" size={20} color="#004643" />
              <Text style={styles.infoText}>
                Hari libur ditentukan dari pengaturan jam kerja. Klik tanggal untuk menambah hari libur khusus
              </Text>
            </View>

            <View style={styles.calendarCard}>
              <View style={styles.calendarHeader}>
                <TouchableOpacity onPress={() => changeMonth(-1)} style={styles.monthBtn}>
                  <Ionicons name="chevron-back" size={24} color="#004643" />
                </TouchableOpacity>
                <Text style={styles.monthText}>{monthName}</Text>
                <TouchableOpacity onPress={() => changeMonth(1)} style={styles.monthBtn}>
                  <Ionicons name="chevron-forward" size={24} color="#004643" />
                </TouchableOpacity>
              </View>

              <View style={styles.weekDays}>
                {['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'].map((day, i) => (
                  <Text key={i} style={styles.weekDayText}>{day}</Text>
                ))}
              </View>

              <View style={styles.daysGrid}>
                {days.map((date, index) => {
                  const isWE = isWeekend(date);
                  const isHol = isHoliday(date);
                  const isToday = date && date.toDateString() === new Date().toDateString();
                  
                  return (
                    <TouchableOpacity
                      key={index}
                      style={[
                        styles.dayCell,
                        !date && styles.emptyCell,
                        (isWE || isHol) && styles.holidayCell,
                        isToday && styles.todayCell
                      ]}
                      onPress={() => handleDatePress(date)}
                      disabled={!date}
                    >
                      {date && (
                        <Text style={[
                          styles.dayText,
                          (isWE || isHol) && styles.holidayText,
                          isToday && styles.todayText
                        ]}>
                          {date.getDate()}
                        </Text>
                      )}
                      {isHol && <View style={styles.holidayDot} />}
                    </TouchableOpacity>
                  );
                })}
              </View>
            </View>

            <View style={styles.legendCard}>
              <Text style={styles.legendTitle}>Keterangan:</Text>
              <View style={styles.legendItem}>
                <View style={[styles.legendBox, { backgroundColor: '#FFEBEE' }]} />
                <Text style={styles.legendText}>Hari Libur (dari pengaturan jam kerja)</Text>
              </View>
              <View style={styles.legendItem}>
                <View style={[styles.legendBox, { backgroundColor: '#FFCDD2' }]} />
                <Text style={styles.legendText}>Hari Libur Khusus</Text>
              </View>
            </View>

            <View style={styles.listCard}>
              <Text style={styles.listTitle}>Daftar Hari Libur</Text>
              {hariLibur.length > 0 ? (
                hariLibur.map((item) => (
                  <View key={item.id} style={styles.listItem}>
                    <View style={styles.listItemLeft}>
                      <Ionicons name="calendar" size={16} color="#004643" />
                      <View style={styles.listItemInfo}>
                        <Text style={styles.listItemName}>{item.nama_libur}</Text>
                        <Text style={styles.listItemDate}>
                          {new Date(item.tanggal).toLocaleDateString('id-ID', { 
                            day: 'numeric', 
                            month: 'long', 
                            year: 'numeric' 
                          })}
                        </Text>
                      </View>
                    </View>
                    <TouchableOpacity onPress={() => handleDeleteHoliday(item.id)}>
                      <Ionicons name="trash-outline" size={20} color="#F44336" />
                    </TouchableOpacity>
                  </View>
                ))
              ) : (
                <Text style={styles.emptyText}>Belum ada hari libur yang ditambahkan</Text>
              )}
            </View>
          </>
        )}
      </ScrollView>

      <Modal visible={showModal} transparent statusBarTranslucent={true}>
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>Hari Libur</Text>
              <TouchableOpacity onPress={() => setShowModal(false)}>
                <Ionicons name="close" size={24} color="#666" />
              </TouchableOpacity>
            </View>

            <Text style={styles.modalDate}>
              {selectedDate?.toLocaleDateString('id-ID', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
              })}
            </Text>

            <View style={styles.formGroup}>
              <Text style={styles.label}>Nama Libur *</Text>
              <TextInput
                style={styles.input}
                placeholder="Contoh: Hari Raya Idul Fitri"
                value={formData.namaLibur}
                onChangeText={(text) => setFormData({ ...formData, namaLibur: text })}
              />
            </View>

            <View style={styles.formGroup}>
              <Text style={styles.label}>Jenis Libur</Text>
              <View style={styles.radioGroup}>
                {['nasional', 'keagamaan', 'perusahaan'].map((jenis) => (
                  <TouchableOpacity
                    key={jenis}
                    style={[styles.radioBtn, formData.jenis === jenis && styles.radioBtnActive]}
                    onPress={() => setFormData({ ...formData, jenis })}
                  >
                    <Text style={[styles.radioText, formData.jenis === jenis && styles.radioTextActive]}>
                      {jenis.charAt(0).toUpperCase() + jenis.slice(1)}
                    </Text>
                  </TouchableOpacity>
                ))}
              </View>
            </View>

            <TouchableOpacity 
              style={[styles.saveBtn, loading && styles.saveBtnDisabled]}
              onPress={handleSaveHoliday}
              disabled={loading}
            >
              <Text style={styles.saveBtnText}>
                {loading ? 'Menyimpan...' : 'Simpan'}
              </Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>
    </View>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: '#F8FAFB' },
  content: {
    flex: 1,
    paddingHorizontal: 16,
    paddingTop: 15
  },
  infoCard: {
    flexDirection: 'row',
    backgroundColor: '#F0F8F7',
    padding: 16,
    borderRadius: 12,
    marginBottom: 16,
    alignItems: 'flex-start'
  },
  infoText: {
    flex: 1,
    fontSize: 12,
    color: '#004643',
    marginLeft: 12,
    lineHeight: 16
  },
  calendarCard: {
    backgroundColor: '#fff',
    borderRadius: 12,
    padding: 16,
    marginBottom: 16,
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 2
  },
  calendarHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16
  },
  monthBtn: {
    padding: 8,
    borderRadius: 8,
    backgroundColor: '#F5F5F5'
  },
  monthText: {
    fontSize: 16,
    fontWeight: '600',
    color: '#333'
  },
  weekDays: {
    flexDirection: 'row',
    marginBottom: 12,
    paddingVertical: 8,
    backgroundColor: '#F8F9FA',
    borderRadius: 8
  },
  weekDayText: {
    flex: 1,
    textAlign: 'center',
    fontSize: 11,
    fontWeight: '600',
    color: '#666'
  },
  daysGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap'
  },
  dayCell: {
    width: '14.28%',
    height: 32,
    justifyContent: 'center',
    alignItems: 'center',
    borderRadius: 6,
    marginBottom: 4
  },
  emptyCell: {
    backgroundColor: 'transparent'
  },
  holidayCell: {
    backgroundColor: '#FFEBEE',
    borderWidth: 1,
    borderColor: '#E53E3E'
  },
  todayCell: {
    backgroundColor: '#004643',
    elevation: 2,
    shadowColor: '#004643',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 3
  },
  dayText: {
    fontSize: 13,
    color: '#333',
    fontWeight: '500'
  },
  holidayText: {
    color: '#E53E3E',
    fontWeight: '600'
  },
  todayText: {
    color: '#FFFFFF',
    fontWeight: '700'
  },
  holidayDot: {
    position: 'absolute',
    bottom: 2,
    width: 4,
    height: 4,
    borderRadius: 2,
    backgroundColor: '#E53E3E'
  },
  legendCard: {
    backgroundColor: '#fff',
    borderRadius: 12,
    padding: 16,
    marginBottom: 16,
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 2
  },
  legendTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#333',
    marginBottom: 12
  },
  legendItem: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 10
  },
  legendBox: {
    width: 18,
    height: 18,
    borderRadius: 4,
    marginRight: 12
  },
  legendText: {
    fontSize: 13,
    color: '#666'
  },
  listCard: {
    backgroundColor: '#fff',
    borderRadius: 12,
    padding: 16,
    marginBottom: 16,
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 2
  },
  listTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#333',
    marginBottom: 16
  },
  listItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: 14,
    paddingHorizontal: 4,
    borderBottomWidth: 1,
    borderBottomColor: '#F0F0F0'
  },
  listItemLeft: {
    flexDirection: 'row',
    alignItems: 'center',
    flex: 1
  },
  listItemInfo: {
    marginLeft: 12,
    flex: 1
  },
  listItemName: {
    fontSize: 15,
    fontWeight: '500',
    color: '#333',
    marginBottom: 4
  },
  listItemDate: {
    fontSize: 13,
    color: '#666'
  },
  emptyText: {
    fontSize: 13,
    color: '#999',
    textAlign: 'center',
    paddingVertical: 24
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.5)',
    justifyContent: 'center',
    alignItems: 'center'
  },
  modalContent: {
    backgroundColor: '#fff',
    borderRadius: 20,
    padding: 20,
    width: '90%',
    maxWidth: 400
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 15
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#333'
  },
  modalDate: {
    fontSize: 14,
    color: '#004643',
    marginBottom: 20,
    fontWeight: '500'
  },
  formGroup: {
    marginBottom: 20
  },
  label: {
    fontSize: 14,
    fontWeight: '600',
    color: '#333',
    marginBottom: 8
  },
  input: {
    backgroundColor: '#F5F5F5',
    borderRadius: 10,
    padding: 12,
    fontSize: 14,
    color: '#333'
  },
  radioGroup: {
    flexDirection: 'row',
    gap: 8
  },
  radioBtn: {
    flex: 1,
    paddingVertical: 10,
    paddingHorizontal: 12,
    borderRadius: 8,
    backgroundColor: '#F5F5F5',
    alignItems: 'center'
  },
  radioBtnActive: {
    backgroundColor: '#004643'
  },
  radioText: {
    fontSize: 12,
    color: '#666',
    fontWeight: '500'
  },
  radioTextActive: {
    color: '#fff'
  },
  saveBtn: {
    backgroundColor: '#004643',
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 16,
    paddingHorizontal: 16,
    borderRadius: 12,
    minHeight: 50
  },
  saveBtnDisabled: {
    backgroundColor: '#999'
  },
  saveBtnText: {
    color: '#fff',
    fontSize: 15,
    fontWeight: '600',
    marginLeft: 6,
    textAlign: 'center'
  }
});
