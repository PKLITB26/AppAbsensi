const { getConnection } = require('../config/database');

const getDinasAktifAdmin = async (req, res) => {
  try {
    console.log('Getting dinas aktif data...');
    const { status } = req.query;
    const db = await getConnection();

    let whereClause = '';
    const today = new Date().toISOString().split('T')[0];
    
    // Filter berdasarkan status jika ada
    if (status) {
      switch (status) {
        case 'berlangsung':
          whereClause = `WHERE DATE(d.tanggal_mulai) <= '${today}' AND DATE(d.tanggal_selesai) >= '${today}'`;
          break;
        case 'selesai':
          whereClause = `WHERE DATE(d.tanggal_selesai) < '${today}'`;
          break;
        case 'belum_dimulai':
          whereClause = `WHERE DATE(d.tanggal_mulai) > '${today}'`;
          break;
      }
    }

    const [rows] = await db.execute(`
      SELECT d.*, 
             COUNT(dp.id) as total_pegawai,
             SUM(CASE WHEN ad.status = 'hadir' THEN 1 ELSE 0 END) as hadir_count
      FROM dinas d 
      LEFT JOIN dinas_pegawai dp ON d.id_dinas = dp.id_dinas 
      LEFT JOIN absen_dinas ad ON d.id_dinas = ad.id_dinas AND dp.id_user = ad.id_user
      ${whereClause}
      GROUP BY d.id_dinas 
      ORDER BY d.tanggal_mulai DESC
    `);

    console.log('Found', rows.length, 'dinas records');
    const dinas_list = [];

    for (const row of rows) {
      // Get lokasi details for this dinas
      let lokasiRows = [];
      try {
        const [rows] = await db.execute(`
          SELECT lk.id, lk.nama_lokasi, lk.alamat, lk.lintang, lk.bujur, lk.radius, dl.is_lokasi_utama
          FROM dinas_lokasi dl
          JOIN lokasi_kantor lk ON dl.id_lokasi_kantor = lk.id
          WHERE dl.id_dinas = ? AND lk.is_active = 1
          ORDER BY dl.urutan
        `, [row.id_dinas]);
        lokasiRows = rows;
      } catch (err) {
        console.log('Lokasi query error, trying fallback:', err.message);
        lokasiRows = [];
      }

      // Get pegawai details for this dinas
      const [pegawaiRows] = await db.execute(`
        SELECT dp.*, p.nama_lengkap, p.nip,
               ad.jam_masuk, ad.jam_pulang, ad.status as absen_status
        FROM dinas_pegawai dp 
        JOIN users u ON dp.id_user = u.id_user
        JOIN pegawai p ON u.id_user = p.id_user
        LEFT JOIN absen_dinas ad ON dp.id_dinas = ad.id_dinas AND dp.id_user = ad.id_user
        WHERE dp.id_dinas = ?
      `, [row.id_dinas]);

      const pegawai = pegawaiRows.map(pegawaiRow => {
        let status = 'belum_absen';
        if (pegawaiRow.absen_status === 'hadir') {
          status = 'hadir';
        } else if (pegawaiRow.absen_status === 'terlambat') {
          status = 'terlambat';
        }

        return {
          nama: pegawaiRow.nama_lengkap,
          nip: pegawaiRow.nip,
          status: status,
          jamAbsen: pegawaiRow.jam_masuk
        };
      });

      dinas_list.push({
        id: row.id_dinas,
        namaKegiatan: row.nama_kegiatan,
        nomorSpt: row.nomor_spt,
        jenisDinas: row.jenis_dinas,
        lokasi: lokasiRows.length > 0 
          ? lokasiRows.map(l => l.nama_lokasi).join(', ') 
          : 'Belum ada lokasi terdaftar',
        lokasi_list: lokasiRows.map(l => ({
          id: l.id,
          nama_lokasi: l.nama_lokasi,
          alamat: l.alamat,
          latitude: parseFloat(l.lintang),
          longitude: parseFloat(l.bujur),
          radius: l.radius,
          is_lokasi_utama: l.is_lokasi_utama
        })),
        jamKerja: `${row.jam_mulai}-${row.jam_selesai}`,
        radius: row.radius_absen,
        koordinat_lat: parseFloat(row.lintang),
        koordinat_lng: parseFloat(row.bujur),
        tanggal_mulai: row.tanggal_mulai,
        tanggal_selesai: row.tanggal_selesai,
        deskripsi: row.deskripsi,
        dokumen_spt: row.dokumen_spt,
        created_at: row.created_at,
        created_by: row.created_by,
        pegawai: pegawai
      });
    }

    res.json({
      success: true,
      data: dinas_list
    });

  } catch (error) {
    console.error('Get dinas aktif error:', error);
    res.json({ success: false, message: 'Database error: ' + error.message });
  }
};

const createDinasAdmin = async (req, res) => {
  let connection;
  try {
    const { nama_kegiatan, nomor_spt, tanggal_mulai, tanggal_selesai, pegawai_ids, lokasi_ids, jam_mulai, jam_selesai, jenis_dinas, deskripsi } = req.body;

    // Validate required fields
    const required_fields = ['nama_kegiatan', 'nomor_spt', 'tanggal_mulai', 'tanggal_selesai', 'pegawai_ids', 'lokasi_ids'];
    for (const field of required_fields) {
      if (!req.body[field] || (typeof req.body[field] === 'string' && req.body[field].trim() === '')) {
        return res.status(400).json({
          success: false,
          message: `Field '${field}' wajib diisi`
        });
      }
    }

    if (!Array.isArray(pegawai_ids) || pegawai_ids.length === 0) {
      return res.status(400).json({
        success: false,
        message: 'Minimal pilih 1 pegawai untuk dinas'
      });
    }

    if (!Array.isArray(lokasi_ids) || lokasi_ids.length === 0) {
      return res.status(400).json({
        success: false,
        message: 'WAJIB pilih minimal 1 lokasi dinas! Tidak boleh kosong.'
      });
    }

    const db = await getConnection();
    connection = await db.getConnection();

    // Get valid admin user ID for created_by
    const [adminRows] = await connection.execute('SELECT id_user FROM users WHERE role = "admin" ORDER BY id_user LIMIT 1');
    let adminUser = adminRows[0];

    if (!adminUser) {
      const [userRows] = await connection.execute('SELECT id_user FROM users ORDER BY id_user LIMIT 1');
      adminUser = userRows[0];
      if (!adminUser) {
        return res.status(400).json({
          success: false,
          message: 'No users found in database'
        });
      }
    }

    // Validate pegawai_ids
    const placeholders = pegawai_ids.map(() => '?').join(',');
    const [validUsers] = await connection.execute(`SELECT id_user FROM users WHERE id_user IN (${placeholders})`, pegawai_ids);

    if (validUsers.length === 0) {
      return res.status(400).json({
        success: false,
        message: 'No valid pegawai IDs found in database'
      });
    }

    // Validate lokasi_ids
    const lokasiPlaceholders = lokasi_ids.map(() => '?').join(',');
    const [validLokasi] = await connection.execute(`SELECT id FROM lokasi_kantor WHERE id IN (${lokasiPlaceholders}) AND is_active = 1`, lokasi_ids);

    if (validLokasi.length === 0) {
      return res.status(400).json({
        success: false,
        message: 'No valid lokasi IDs found in database'
      });
    }

    await connection.beginTransaction();

    try {
      // Insert dinas data (keep old fields for backward compatibility)
      const [result] = await connection.execute(`
        INSERT INTO dinas (
          nama_kegiatan, nomor_spt, jenis_dinas, tanggal_mulai, tanggal_selesai,
          jam_mulai, jam_selesai, alamat_lengkap, latitude, longitude, radius_absen,
          deskripsi, status, created_by, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'aktif', ?, NOW())
      `, [
        nama_kegiatan.trim(),
        nomor_spt.trim(),
        jenis_dinas || 'lokal',
        tanggal_mulai,
        tanggal_selesai,
        jam_mulai || '08:00:00',
        jam_selesai || '17:00:00',
        'Multiple Locations',
        -6.8915,
        107.6107,
        100,
        deskripsi || '',
        adminUser.id_user
      ]);

      const dinas_id = result.insertId;

      // Insert lokasi dinas relationships
      for (let i = 0; i < validLokasi.length; i++) {
        await connection.execute(`
          INSERT INTO dinas_lokasi (id_dinas, id_lokasi_kantor, id_lokasi, urutan, is_lokasi_utama)
          VALUES (?, ?, ?, ?, ?)
        `, [dinas_id, validLokasi[i].id, validLokasi[i].id, i + 1, i === 0 ? 1 : 0]);
      }

      // Insert pegawai dinas relationships
      for (const user of validUsers) {
        await connection.execute(`
          INSERT INTO dinas_pegawai (id_dinas, id_user, status_konfirmasi, tanggal_konfirmasi)
          VALUES (?, ?, 'konfirmasi', NOW())
        `, [dinas_id, user.id_user]);
      }

      await connection.commit();

      res.status(201).json({
        success: true,
        message: 'Data dinas berhasil disimpan',
        data: {
          dinas_id: dinas_id,
          nama_kegiatan: nama_kegiatan,
          nomor_spt: nomor_spt
        }
      });

    } catch (error) {
      await connection.rollback();
      throw error;
    }

  } catch (error) {
    console.error('Create dinas error:', error);
    res.status(400).json({
      success: false,
      message: error.message
    });
  } finally {
    if (connection) {
      connection.release();
    }
  }
};

const getRiwayatDinasAdmin = async (req, res) => {
  try {
    const db = await getConnection();

    const [rows] = await db.execute(`
      SELECT d.*, 
             COUNT(dp.id) as total_pegawai,
             SUM(CASE WHEN ad.status = 'hadir' THEN 1 ELSE 0 END) as hadir_count
      FROM dinas d 
      LEFT JOIN dinas_pegawai dp ON d.id_dinas = dp.id_dinas 
      LEFT JOIN absen_dinas ad ON d.id_dinas = ad.id_dinas AND dp.id_user = ad.id_user
      WHERE d.status IN ('selesai', 'dibatalkan')
      GROUP BY d.id_dinas 
      ORDER BY d.tanggal_mulai DESC
    `);

    res.json({
      success: true,
      data: rows
    });

  } catch (error) {
    console.error('Get riwayat dinas error:', error);
    res.json({ success: false, message: 'Database error: ' + error.message });
  }
};

const getValidasiAbsenAdmin = async (req, res) => {
  try {
    const db = await getConnection();

    // Remove the status_validasi filter since the column doesn't exist
    const [rows] = await db.execute(`
      SELECT ad.*, p.nama_lengkap, p.nip, d.nama_kegiatan
      FROM absen_dinas ad
      JOIN users u ON ad.id_user = u.id_user
      JOIN pegawai p ON u.id_user = p.id_user
      JOIN dinas d ON ad.id_dinas = d.id_dinas
      ORDER BY ad.tanggal_absen DESC
    `);

    res.json({
      success: true,
      data: rows
    });

  } catch (error) {
    console.error('Get validasi absen error:', error);
    res.json({ success: false, message: 'Database error: ' + error.message });
  }
};

const getDinasStats = async (req, res) => {
  try {
    const db = await getConnection();
    
    // Get today's date
    const today = new Date().toISOString().split('T')[0];
    
    // Count active dinas (dinas that are ongoing today)
    const [dinasAktifRows] = await db.execute(`
      SELECT COUNT(*) as count 
      FROM dinas 
      WHERE DATE(tanggal_mulai) <= ? 
      AND (DATE(tanggal_selesai) >= ? OR tanggal_selesai IS NULL)
      AND status = 'aktif'
    `, [today, today]);
    
    // Count completed dinas today
    const [selesaiDinasRows] = await db.execute(`
      SELECT COUNT(*) as count 
      FROM dinas 
      WHERE DATE(tanggal_selesai) = ? 
      AND status = 'selesai'
    `, [today]);
    
    // Count total employees on dinas today
    const [pegawaiDinasRows] = await db.execute(`
      SELECT COUNT(DISTINCT dp.id_user) as count 
      FROM dinas d
      JOIN dinas_pegawai dp ON d.id_dinas = dp.id_dinas
      WHERE DATE(d.tanggal_mulai) <= ? 
      AND (DATE(d.tanggal_selesai) >= ? OR d.tanggal_selesai IS NULL)
      AND d.status = 'aktif'
    `, [today, today]);
    
    // Count employees who haven't checked in today (among those on dinas)
    const [belumAbsenRows] = await db.execute(`
      SELECT COUNT(DISTINCT dp.id_user) as count 
      FROM dinas d
      JOIN dinas_pegawai dp ON d.id_dinas = dp.id_dinas
      LEFT JOIN absen_dinas ad ON dp.id_dinas = ad.id_dinas AND dp.id_user = ad.id_user AND DATE(ad.tanggal_absen) = ?
      WHERE DATE(d.tanggal_mulai) <= ? 
      AND (DATE(d.tanggal_selesai) >= ? OR d.tanggal_selesai IS NULL)
      AND d.status = 'aktif'
      AND ad.id_user IS NULL
    `, [today, today, today]);
    
    const stats = {
      dinasAktif: dinasAktifRows[0].count || 0,
      selesaiDinas: selesaiDinasRows[0].count || 0,
      pegawaiDinas: pegawaiDinasRows[0].count || 0,
      belumAbsen: belumAbsenRows[0].count || 0
    };
    
    res.json({
      success: true,
      data: stats
    });
    
  } catch (error) {
    console.error('Error fetching dinas stats:', error);
    res.json({
      success: false,
      message: 'Database error: ' + error.message,
      data: {
        dinasAktif: 0,
        selesaiDinas: 0,
        pegawaiDinas: 0,
        belumAbsen: 0
      }
    });
  }
};

const getDinasLokasi = async (req, res) => {
  try {
    const { id_dinas } = req.params;
    const db = await getConnection();

    const [rows] = await db.execute(`
      SELECT lk.*, dl.urutan, dl.is_lokasi_utama
      FROM dinas_lokasi dl
      JOIN lokasi_kantor lk ON dl.id_lokasi_kantor = lk.id
      WHERE dl.id_dinas = ? AND lk.is_active = 1
      ORDER BY dl.urutan
    `, [id_dinas]);

    res.json({
      success: true,
      data: rows
    });
  } catch (error) {
    console.error('Get dinas lokasi error:', error);
    res.json({ success: false, message: 'Database error: ' + error.message });
  }
};

const checkAbsenLocation = async (req, res) => {
  try {
    const { id_dinas, latitude, longitude } = req.body;
    
    if (!id_dinas || !latitude || !longitude) {
      return res.status(400).json({
        success: false,
        message: 'id_dinas, latitude, dan longitude wajib diisi'
      });
    }

    const db = await getConnection();

    // Get all locations for this dinas
    const [lokasi] = await db.execute(`
      SELECT lk.*, dl.is_lokasi_utama
      FROM dinas_lokasi dl
      JOIN lokasi_kantor lk ON dl.id_lokasi_kantor = lk.id
      WHERE dl.id_dinas = ? AND lk.is_active = 1
    `, [id_dinas]);

    if (lokasi.length === 0) {
      return res.json({
        success: false,
        message: 'Tidak ada lokasi dinas yang terdaftar'
      });
    }

    // Check if user is within radius of any location
    const userLat = parseFloat(latitude);
    const userLng = parseFloat(longitude);

    for (const loc of lokasi) {
      const distance = calculateDistance(
        userLat,
        userLng,
        parseFloat(loc.latitude),
        parseFloat(loc.longitude)
      );

      if (distance <= loc.radius) {
        return res.json({
          success: true,
          inRadius: true,
          lokasi: {
            id: loc.id,
            nama: loc.nama_lokasi,
            alamat: loc.alamat,
            distance: Math.round(distance)
          }
        });
      }
    }

    // Not in any location radius
    res.json({
      success: true,
      inRadius: false,
      message: 'Anda berada di luar radius semua lokasi dinas'
    });

  } catch (error) {
    console.error('Check location error:', error);
    res.status(500).json({ success: false, message: 'Server error: ' + error.message });
  }
};

// Haversine formula to calculate distance between two coordinates
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // Earth radius in meters
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
    Math.cos(φ1) * Math.cos(φ2) *
    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c; // Distance in meters
}

module.exports = { 
  getDinasAktifAdmin, 
  createDinasAdmin, 
  getRiwayatDinasAdmin, 
  getValidasiAbsenAdmin,
  getDinasStats,
  getDinasLokasi,
  checkAbsenLocation
};
